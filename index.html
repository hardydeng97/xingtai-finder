<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邢台在哪儿</title>
    <style>
        :root {
            --primary-red: #ff4757;
            --dark-blue: #2f3542;
            --xt-gold: #f39c12;
        }
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f1f2f6;
            font-family: sans-serif;
            overflow: hidden;
        }

        /* 外部大圆盘 */
        .compass-dial {
            position: relative;
            width: 320px;
            height: 320px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid #fff;
        }

        /* 方位标识 */
        .mark { position: absolute; font-weight: bold; color: #ced4da; font-size: 14px; }
        .n { top: 10px; color: var(--primary-red); }
        .s { bottom: 10px; }
        .w { left: 10px; }
        .e { right: 10px; }

        /* 邢台文字容器：它会根据方位角旋转，从而让文字出现在圆周正确位置 */
        #xt-target-container {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 0.5s ease-out;
            display: none; /* 初始隐藏 */
        }
        .xt-label {
            position: absolute;
            top: 35px; /* 距离边缘的距离 */
            left: 50%;
            transform: translateX(-50%);
            color: var(--xt-gold);
            font-size: 20px;
            font-weight: bold;
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* 指针容器 */
        .needle-wrapper {
            position: absolute;
            width: 24px;
            height: 220px;
            transition: transform 0.2s cubic-bezier(0.1, 0.5, 0.2, 1);
            display: none; /* 初始隐藏 */
        }
        .needle-red {
            width: 0; height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 110px solid var(--primary-red);
        }
        .needle-dark {
            width: 0; height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 110px solid var(--dark-blue);
        }

        .center-pivot {
            width: 10px; height: 10px;
            background: #fff; border: 3px solid var(--dark-blue);
            border-radius: 50%; position: absolute; z-index: 10;
        }

        .info { margin-top: 40px; text-align: center; }
        #dist-val { font-size: 32px; font-weight: bold; color: var(--dark-blue); }
        #hint { color: #7f8c8d; font-size: 14px; margin-top: 10px; }

        .btn-go {
            padding: 15px 40px; background: var(--dark-blue); color: #fff;
            border: none; border-radius: 50px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="compass-dial">
        <div class="mark n">N</div>
        <div class="mark s">S</div>
        <div class="mark w">W</div>
        <div class="mark mark e">E</div>

        <div id="xt-target-container">
            <div class="xt-label">邢台</div>
        </div>

        <div class="needle-wrapper" id="needle">
            <div class="needle-red"></div>
            <div class="needle-dark"></div>
        </div>
        
        <div class="center-pivot"></div>
    </div>

    <div class="info">
        <div id="dist-val">-- km</div>
        <div id="hint">点击下方开始定位</div>
        <br>
        <button class="btn-go" id="startBtn">开启指引</button>
    </div>

    <script>
        const XINGTAI = { lat: 37.07, lng: 114.50 };
        let userPos = null;
        let bearingToXT = 0;

        function getBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin((lon2 - lon1) * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                      Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos((lon2 - lon1) * Math.PI / 180);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        async function init() {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('hint').innerText = "请求位置授权中...";

            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                const res = await DeviceOrientationEvent.requestPermission();
                if (res !== 'granted') return;
            }

            navigator.geolocation.watchPosition(pos => {
                userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                
                // 计算距离
                const R = 6371;
                const dLat = (XINGTAI.lat - userPos.lat) * Math.PI / 180;
                const dLon = (XINGTAI.lng - userPos.lng) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(userPos.lat*Math.PI/180)*Math.cos(XINGTAI.lat*Math.PI/180)*Math.sin(dLon/2)**2;
                const dist = (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
                
                document.getElementById('dist-val').innerText = dist + " km";

                // 计算邢台在轮盘上的绝对方位角度
                bearingToXT = getBearing(userPos.lat, userPos.lng, XINGTAI.lat, XINGTAI.lng);
                
                // 让“邢台”文字出现在轮盘对应的角度上
                const xtContainer = document.getElementById('xt-target-container');
                xtContainer.style.display = 'block';
                xtContainer.style.transform = `rotate(${bearingToXT}deg)`;
                
                document.getElementById('needle').style.display = 'block';
                document.getElementById('hint').innerText = "已在轮盘标出邢台方向";
            });

            window.addEventListener('deviceorientationabsolute', e => {
                let heading = e.webkitCompassHeading || (360 - e.alpha);
                if (heading !== undefined && userPos) {
                    // 指针旋转角度 = 邢台方位角 - 手机当前朝向
                    const needleAngle = bearingToXT - heading;
                    document.getElementById('needle').style.transform = `rotate(${needleAngle}deg)`;
                }
            }, true);
        }

        document.getElementById('startBtn').addEventListener('click', init);
    </script>
</body>
</html>
