<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>邢台在哪儿</title>
    <style>
        :root {
            --primary-red: #ff4757;
            --dark-blue: #2f3542;
            --xt-gold: #f39c12;
        }
        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: 100vh; background-color: #f1f2f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
        }

        /* 外部大圆盘：这是固定的背景 */
        .compass-dial {
            position: relative;
            width: 320px; height: 320px;
            background: #fff; border-radius: 50%;
            box-shadow: 0 15px 45px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            border: 6px solid #fff;
        }

        /* 方位标识：N/S/E/W */
        .mark { position: absolute; font-weight: bold; color: #ced4da; font-size: 16px; }
        .n { top: 15px; color: var(--primary-red); }
        .s { bottom: 15px; }
        .w { left: 15px; }
        .e { right: 15px; }

        /* 邢台文字容器：在授权后显示 */
        #xt-target-container {
            position: absolute;
            width: 100%; height: 100%;
            display: none; /* 初始隐藏 */
            z-index: 5;
        }
        .xt-label {
            position: absolute;
            top: 45px; left: 50%;
            transform: translateX(-50%);
            color: var(--xt-gold);
            font-size: 22px; font-weight: bold;
            background: rgba(255,255,255,0.9);
            padding: 2px 8px; border-radius: 4px;
            border: 1px solid var(--xt-gold);
        }

        /* 指针容器 */
        #needle {
            position: absolute;
            width: 30px; height: 240px;
            display: none; /* 初始隐藏 */
            z-index: 10;
        }
        .needle-red {
            width: 0; height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 120px solid var(--primary-red);
        }
        .needle-dark {
            width: 0; height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 120px solid var(--dark-blue);
        }

        .center-pivot {
            width: 12px; height: 12px;
            background: #fff; border: 3px solid var(--dark-blue);
            border-radius: 50%; position: absolute; z-index: 20;
        }

        .info { margin-top: 40px; text-align: center; }
        #dist-val { font-size: 36px; font-weight: 800; color: var(--dark-blue); }
        #hint { color: #7f8c8d; font-size: 14px; margin-top: 10px; padding: 0 20px;}

        .btn-go {
            margin-top: 20px; padding: 16px 48px;
            background: var(--dark-blue); color: #fff;
            border: none; border-radius: 50px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body>

    <div class="compass-dial">
        <div class="mark n">N</div>
        <div class="mark s">S</div>
        <div class="mark w">W</div>
        <div class="mark e">E</div>

        <div id="xt-target-container">
            <div class="xt-label">邢台</div>
        </div>

        <div id="needle">
            <div class="needle-red"></div>
            <div class="needle-dark"></div>
        </div>
        
        <div class="center-pivot"></div>
    </div>

    <div class="info">
        <div id="dist-val">-- km</div>
        <div id="hint">请点击下方按钮并允许权限</div>
        <button class="btn-go" onclick="requestPermissions()">开始寻找邢台</button>
    </div>

    <script>
        const XINGTAI_COORDS = { lat: 37.07, lng: 114.50 };
        let userCoords = null;
        let bearingToXT = 0;

        // 计算方位角
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        async function requestPermissions() {
            const hintEl = document.getElementById('hint');
            const btn = document.querySelector('.btn-go');

            // 1. 请求位置权限
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    updateDistance();
                    setupOrientation();
                    btn.style.display = 'none';
                    hintEl.innerText = "权限已获取，请水平平放手机并转动";
                },
                (err) => {
                    hintEl.innerText = "无法获取位置，请在设置中开启 GPS 权限";
                    console.error(err);
                }
            );

            // 2. iOS 13+ 方向传感器权限特殊处理
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response !== 'granted') {
                        hintEl.innerText = "请允许动作传感器权限以使用指南针";
                    }
                } catch (e) {
                    console.error(e);
                }
            }
        }

        function updateDistance() {
            if (!userCoords) return;
            const R = 6371;
            const dLat = (XINGTAI_COORDS.lat - userCoords.lat) * Math.PI / 180;
            const dLon = (XINGTAI_COORDS.lng - userCoords.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(userCoords.lat*Math.PI/180)*Math.cos(XINGTAI_COORDS.lat*Math.PI/180)*Math.sin(dLon/2)**2;
            const d = (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
            document.getElementById('dist-val').innerText = d + " km";
            
            // 计算邢台相对于地理北极的角度
            bearingToXT = calculateBearing(userCoords.lat, userCoords.lng, XINGTAI_COORDS.lat, XINGTAI_COORDS.lng);
            
            // 显示并旋转文字容器到正确方位
            const xtContainer = document.getElementById('xt-target-container');
            xtContainer.style.display = 'block';
            xtContainer.style.transform = `rotate(${bearingToXT}deg)`;
            document.getElementById('needle').style.display = 'block';
        }

        function setupOrientation() {
            const handleOrientation = (event) => {
                // webkitCompassHeading 是 iOS 特有的，最准确
                // alpha 是安卓标准的，通常需要取反
                let heading = event.webkitCompassHeading;
                if (heading === undefined) {
                    heading = 360 - event.alpha;
                }

                if (heading !== undefined && userCoords) {
                    // 指针转动逻辑：
                    // 目标角度 = 邢台方位角 - 手机当前朝向角度
                    const needleRotation = bearingToXT - heading;
                    document.getElementById('needle').style.transform = `rotate(${needleRotation}deg)`;
                }
            };

            // 优先使用 absolute 事件获取绝对地理北极
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', handleOrientation);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }
    </script>
</body>
</html>
